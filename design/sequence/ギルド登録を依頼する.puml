@startuml

actor ゲスト as guest
boundary ギルド登録依頼FORM as form
control ギルド仮登録ハンドラー as handler
control ギルド登録依頼トークンチェックハンドラー as handler2
database guest_token
database guild
participant メール送信サービス as mail

guest -> form:ギルド登録を依頼
form -> handler:ギルド名、メールアドレス
handler -> handler:トランザクション開始
handler -> guest_token:既存トークン取得(メールアドレス、有効期限内)
guest_token -> handler:トークン
alt has valid token
handler -> form:トークン
form -> handler2:リダイレクト(トークン)
end
handler -> guild:ギルド登録(ギルド名、ステータス＝仮登録)
guild -> handler:ギルドID
handler -> handler:トークン生成、有効期限決定
handler -> guest_token:トークン登録(トークン、有効期限、メールアドレス、ギルドID)
handler -> handler:トランザクション終了
handler -> mail:メールアドレス、トークン、有効期限
handler -> form:受付番号
form -> guest:受付番号

@enduml